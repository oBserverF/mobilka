# Blueprint: Meditation Harmony App

## 1. Обзор проекта

**Цель:** Разработка кросс-платформенного мобильного приложения для медитации "Meditation Harmony". Приложение поможет пользователям расслабляться, снижать стресс и улучшать концентрацию с помощью аудиогидов, фоновой музыки и интерактивных упражнений.

**Технологический стек:**
- **Frontend:** Flutter
- **Backend:** Node.js (согласно ТЗ)
- **База данных и Аутентификация:** Firebase

## 2. Реализованные стили, дизайны и функции

### Версия 0.1

- **Начальная структура проекта:** Создан базовый проект Flutter.
- **Навигация:** Реализована основная навигация с помощью `BottomNavigationBar`.
- **Экраны:** Созданы файлы-заглушки для `home_screen.dart`, `meditations_screen.dart`, `library_screen.dart`, `profile_screen.dart`.
- **Тема:** Настроена базовая тема приложения (`ThemeData`) в минималистичном стиле.

### Версия 0.2

- **Управление состоянием:** Интегрирован пакет `flutter_hooks`.
- **Архитектура:** Создан сервисный слой (`MeditationService`) и модель данных (`Meditation`) для управления данными.
- **Экран "Медитации":** Экран преобразован в `HookWidget` для асинхронной загрузки и отображения списка медитаций с обработкой состояний загрузки и ошибок.

### Версия 0.3

- **Архитектура управления состоянием:**
    - Добавлена зависимость `provider`.
    - Создана модель `Music`, сервис `MusicService` и провайдер `MusicProvider` для управления выбором фоновой музыки.
    - Приложение обернуто в `ChangeNotifierProvider` для глобального доступа к `MusicProvider`.
- **Экран "Библиотека":**
    - Реализован экран для выбора фоновой музыки из списка.
    - Выбранная музыка сохраняется в `MusicProvider`.
- **Рефакторинг `MeditationPlayerScreen`:**
    - Удалена локальная логика выбора фоновой музыки.
    - Экран теперь получает информацию о выбранном треке из `MusicProvider`.

### Версия 0.4

- **Улучшенный UX запуска медитации:**
    - **Модальное окно:** При выборе медитации появляется модальное окно `MeditationStartSheet` для настройки длительности таймера.
    - **Автоматический запуск:** Плеер `MeditationPlayerScreen` теперь принимает заданную длительность, автоматически запускает воспроизведение медитации и фоновой музыки при открытии.
- **Обновленная библиотека музыки:**
    - **Премиум-контент:** В модель `Music` добавлено поле `isPremium`.
    - **UI Библиотеки:** Экран `LibraryScreen` теперь визуально разделяет доступные и "премиум" (заблокированные) треки. Пользователь не может выбрать премиум-треки, но видит их в списке.
- **Рефакторинг:**
    - **`MeditationsScreen`:** Логика нажатия изменена для вызова модального окна.
    - **`MeditationPlayerScreen`:** Переработан для приема `duration` и автозапуска.

### Версия 0.5 (Текущая)

- **Исправление ошибки аудио на Android:**
    - **Диагностика:** Выявлена ошибка `MediaPlayer` (`setDataSourceFD failed`), связанная с некорректной инициализацией Firebase.
    - **Исправление путей:** Скорректированы пути к аудиофайлам в `MeditationService` и `MusicService`, добавлен префикс `assets/`.
    - **Интеграция Firebase:**
        - Добавлены зависимости `firebase_core` и `firebase_app_check`.
        - В `lib/main.dart` добавлена асинхронная инициализация Firebase.
        - Активирован `Firebase App Check` в режиме отладки для Android для обеспечения корректной работы в debug-сборках.

## 3. План текущих изменений (Выполнено)

**Задача:** Устранить критическую ошибку воспроизведения аудио на Android, приводившую к падению приложения.

**Шаги:**

1.  **Диагностика:** Выявлены ошибки `MediaPlayer` и `Firebase App Check`. (Выполнено)
2.  **Добавление зависимостей:** В `pubspec.yaml` добавлены `firebase_core` и `firebase_app_check`. (Выполнено)
3.  **Инициализация Firebase:** В `lib/main.dart` реализована правильная асинхронная инициализация Firebase и `App Check` для отладочного режима Android. (Выполнено)
4.  **Исправление путей:** Скорректированы пути к аудиофайлам в `MeditationService` и `MusicService`. (Выполнено)
5.  **Обновление `blueprint.md`:** Задокументированы все этапы исправления. (Выполнено)
